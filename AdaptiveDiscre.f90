
SUBROUTINE AdaptiveDiscre(NP,Norm,PR0,PF0,PL0,SRm,SFm,SLm,dSR,dSF,dSL,IV,IA,IG)
!-------------------------------------------------------------------------------------------
                                                                  USE Const,ONLY: LMAX,alpha
  IMPLICIT NONE

  INTEGER(KIND=4) :: NP
  REAL   (KIND=8) :: Norm,PR0,PF0,PL0,SRm,SFm,SLm,dSR,dSF,dSL,IV(0:NP),IA(0:NP,3),IG(0:NP,6)
  
  INTEGER(KIND=4) :: NN
  REAL   (KIND=8) :: P0(3),S0(3),dS0(3),CT(3)
!-------------------------------------------------------------------------------------------  
  
  

                                         
                !-------------------------------------------------------------
                P0(1)=PR0;                P0(2)=PF0;                P0(3)=PL0  
                S0(1)=SRm;                S0(2)=SFm;                S0(3)=SLm  
                dS0(1)=dSR;               dS0(2)=dSF;               dS0(3)=dSL 
                !-------------------------------------------------------------
                IV(:)=0.D0;               IA(:,:)=0.D0;             IG(:,:)=0.D0
                !-------------------------------------------------------------
                

          
                !-------------------------------------------------------------
                CT(1)=1.D0; CT(2)=S0(1)+dS0(1)/2.; CT(3)=CT(2)*COS(S0(2)-dS0(2)/2.) 
                !-------------------------------------------------------------
                LMAX=MAXVAL(dS0(2:3)*CT(2:3))/alpha
                !-------------------------------------------------------------
                
                                                                                 
                !-------------------------------------------------------------
                NN=0;  CALL Func_2D(NP,Norm,P0,S0,dS0,IV,IA,IG,NN)
                !-------------------------------------------------------------
 
               
!-------------------------------------------------------------------------------------------
                                                                                    RETURN
END SUBROUTINE
!===========================================================================================
    
       
    
    
    
RECURSIVE SUBROUTINE Func_2D(NP,Norm,P0,S0,dS0,IV,IA,IG,NN)
!-------------------------------------------------------------------------------------------
                                                                                 USE Gauss
  IMPLICIT NONE

  INTEGER(KIND=4) :: NP
  REAL   (KIND=8) :: Norm,P0(3),S0(3),dS0(3),IV(0:NP),IA(0:NP,3),IG(0:NP,6)
  
  INTEGER(KIND=4) :: SGN,NN
  REAL   (KIND=8) :: S1(3),S2(3),dS(3),V0(0:NP),A0(0:NP,3),G0(0:NP,6)
!-------------------------------------------------------------------------------------------  
                

                
                                                                                                                              
                !-------------------------------------------------------------
                CALL Judgement_2D(Norm,P0,S0,dS0,S1,S2,dS,SGN)
                !-------------------------------------------------------------
                IF(SGN==0) THEN
                    !---------------------------------------------------------
                    CALL Tesseroid(NP,P0(1),P0(2),P0(3),S0(1),S0(2),S0(3),dS0(1),dS0(2),dS0(3),V0,A0,G0)
                    !---------------------------------------------------------
                    IV(:)=IV(:)+V0(:)
                    IA(:,:)=IA(:,:)+A0(:,:)
                    IG(:,:)=IG(:,:)+G0(:,:)
                    !---------------------------------------------------------
                ELSE
                    !---------------------------------------------------------
                    CALL Func_2D(NP,Norm,P0,S1,dS,IV,IA,IG,NN)
                    CALL Func_2D(NP,Norm,P0,S2,dS,IV,IA,IG,NN)
                    NN=NN+1
                    !---------------------------------------------------------
                END IF
                !-------------------------------------------------------------
                
                
!-------------------------------------------------------------------------------------------
                                                                                    RETURN
END SUBROUTINE
!===========================================================================================
    
    
    
    
    
SUBROUTINE Judgement_2D(Norm,P0,S0,dS0,S1,S2,dS,SGN)
!-------------------------------------------------------------------------------------------
                                                                       USE Const,ONLY: LMAX
  IMPLICIT NONE

  INTEGER(KIND=4) :: SGN
  REAL   (KIND=8) :: Norm,P0(3),S0(3),dS0(3),S1(3),S2(3),dS(3)
  
  INTEGER(KIND=4) :: IMAX(1)
  REAL   (KIND=8) :: DD,COSF,CT(3)
!-------------------------------------------------------------------------------------------  
                
                
                                                                                                                           
                !-------------------------------------------------------------
                S1(:)=S0(:);             S2(:)=S0(:);              dS(:)=dS0(:)
                CT(1)=1.D0;              CT(2)=S0(1)+dS0(1)/2.;    CT(3)=CT(2)*COS(S0(2)) 
                !-------------------------------------------------------------
               
                
       
                                                                                               
                !-------------------------------------------------------------
                COSF=SIN(P0(2))*SIN(S0(2))+COS(P0(2))*COS(S0(2))*COS(P0(3)-S0(3))
                !-------------------------------------------------------------
                DD=SQRT(P0(1)**2+CT(2)**2-2.*P0(1)*CT(2)*COSF)
                !-------------------------------------------------------------
                IF(DD>=Norm*MAXVAL(dS0(2:3)*CT(2:3)) .OR. (MAXVAL(dS0(2:3)*CT(2:3))<=LMAX .AND. ABS(CT(2)-P0(1))<1.D-16)) THEN
                    !---------------------------------------------------------
                    SGN=0;     S1(:)=0.D0;     S2(:)=0.D0;    dS(:)=0.D0
                    !---------------------------------------------------------
                ELSE
                    !---------------------------------------------------------
                    SGN=1;               IMAX=1+MAXLOC(dS0(2:3)*CT(2:3))
                    !---------------------------------------------------------
                    S1(IMAX)=S0(IMAX)-dS0(IMAX)*0.25
                    S2(IMAX)=S0(IMAX)+dS0(IMAX)*0.25
                    dS(IMAX)=dS0(IMAX)*0.5
                    !---------------------------------------------------------
                END IF
                !-------------------------------------------------------------
                    
                
                
!-------------------------------------------------------------------------------------------
                                                                                    RETURN
END SUBROUTINE
!===========================================================================================


